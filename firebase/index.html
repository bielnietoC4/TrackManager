<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>TrackManager</title>
	<link rel="stylesheet" href="styles.css">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase-firestore.js"></script>
</head>

<body>
	<div class="container p-5">
		<div class="row">

			<div class="col-8 offset-2" id="loginForm">
				<form>
					<div class="form-group row">
						<label for="title" class="col-4 col-form-label">Correu electrònic:</label>
						<div class="col-8">
							<input type="email" class="form-control" id="loginEmail">
						</div>
					</div>
					<div class="form-group row">
						<label for="content" class="col-4 col-form-label">Contrasenya:</label>
						<div class="col-8">
							<input type="password" class="form-control" id="loginPassword">
						</div>
					</div>
					<div class="form-group row">
						<div class="offset-4 col-8">
							<button type="button" id="newUser" class="btn btn-outline-primary float-right">Registrar un
								nou usuari</button>
							<button type="button" id="login" class="btn btn-default float-right mr-3">Entrar</button>
						</div>
					</div>
				</form>
			</div>

			<div class="col-8 offset-2" id="signupForm" style="display: none;">
				<form>
					<div class="form-group row">
						<label for="title" class="col-4 col-form-label">Correu electrònic:</label>
						<div class="col-8">
							<input type="email" class="form-control" id="signupEmail">
						</div>
					</div>
					<div class="form-group row">
						<label for="content" class="col-4 col-form-label">Contrasenya:</label>
						<div class="col-8">
							<input type="password" class="form-control" id="signupPassword">
						</div>
					</div>
					<div class="form-group row">
						<label for="content" class="col-4 col-form-label">Confirmar contrasenya:</label>
						<div class="col-8">
							<input type="password" class="form-control" id="signupPasswordConfirm">
						</div>
					</div>
					<div class="form-group row">
						<div class="offset-4 col-8">
							<button type="button" id="signup" class="btn btn-default float-right">Enviar</button>
						</div>
					</div>
				</form>
			</div>

			<div class="col-8 offset-2" id="CompeticiónForm" style="display: none;">
				<form>
				  <div class="form-group row">
					<label for="elementId" class="col-4 col-form-label">Nombre de la competición:</label>
					<div class="col-8">
					  <input type="text" class="form-control" id="elementId">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="logo" class="col-4 col-form-label">Logo:</label>
					<div class="col-8">
					  <input type="file" class="form-control-file" id="logo">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="categoria" class="col-4 col-form-label">Categoría:</label>
					<div class="col-8">
						<select class="form-control" id="categoria">
							<option value="Coches">Coches</option>
							<option value="Motos">Motos</option>
						</select>
					</div>
				  </div>
				  <div class="form-group row">
					<label for="circuitos" class="col-4 col-form-label">Circuitos:</label>
					<div class="col-8">
					  <input type="text" class="form-control" id="circuitos">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="equipos" class="col-4 col-form-label">Equipos:</label>
					<div class="col-8">
					  <input type="text" class="form-control" id="equipos">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="data_inici" class="col-4 col-form-label">Fecha de inicio:</label>
					<div class="col-8">
					  <input type="date" class="form-control" id="data_inici">
					</div>
				  </div>
				  <div class="form-group row">
					<label for="data_fi" class="col-4 col-form-label">Fecha de fin:</label>
					<div class="col-8">
					  <input type="date" class="form-control" id="data_fi">
					</div>
				  </div>
				  <div class="form-group row">
					<div class="offset-4 col-8">
					  <button type="button" id="guardar" class="btn btn-default float-right">Guardar</button>
					</div>
				  </div>
				</form>
			  </div>

			<div class="col-2">
				<div id="alert" role="alert"></div>
			</div>
		</div>
		<div class="table-responsive">
			<table class="table table-hover" id="listCompetición" style="display: none;">
			</table>
		</div>
	</div>
</body>
<script language="javascript" src="js/config.js"></script>
<script language="javascript" src="js/firestore.js"></script>
<script language="javascript" src="js/storage.js"></script>
<script language="javascript" src="js/items.js"></script>
<script language="javascript">

	let imatgeModificada = false;

	function deleteItem(id) {
		db.collection("Competición").doc(id).get()
		 .then((doc) => {
			if (doc.exists) {
			  // Eliminar archivo asociado en el Storage
			  var storageRef = firebase.storage().ref();
			  var fileRef = storageRef.child(`images/Competición/${id}/${doc.data().logo.name}`);
			  fileRef.delete()
			   .then(() => {
				  console.log("File deleted successfully!");
			   })
			   .catch((error) => {
				  console.error("Error deleting file:", error);
			   });
			  
			  // Eliminar elemento en la base de datos
			  doc.ref.delete()
			   .then(() => {
				  console.log("Element deleted successfully!");
				  loadCompetición(); // reload the data
			   })
			   .catch((error) => {
				  console.error("Error deleting element:", error);
			   });
			} else {
			  console.log("Element not found!");
			}
		 })
		 .catch((error) => {
			console.error("Error getting element:", error);
		 });
	  }

	function showAlert(text, type) {
		document.getElementById("alert").innerText = text;
		document.getElementById("alert").className = "alert " + type;
		document.getElementById("alert").style.display = "block";
		window.setTimeout(function () {
			document.getElementById("alert").style.display = "none";
		}, 2000);
	}

	window.addEventListener("load", function () {
        loadCompetición();
    });

	document.getElementById("login").addEventListener("click", function () {
		let email = document.getElementById("loginEmail").value;
		let password = document.getElementById("loginPassword").value;

		auth.signInWithEmailAndPassword(email, password)
			.then(function () {
				showAlert("Usuari autenticat", "alert-success");

				document.getElementById("loginForm").style.display = "none";
				document.getElementById("CompeticiónForm").style.display = "block";
				document.getElementById("listCompetición").style.display = "table";
			})
			.catch(function (error) {
				showAlert("Error d’autenticació", "alert-danger");
			});
	});

	document.getElementById("newUser").addEventListener("click", function () {
		document.getElementById("loginForm").style.display = "none";
		document.getElementById("signupForm").style.display = "block";
	});

	document.getElementById("signup").addEventListener("click", function () {
		let email = document.getElementById("signupEmail").value;
		let password = document.getElementById("signupPassword").value;
		let passwordConfirm = document.getElementById("signupPasswordConfirm").value;

		if (email.length > 0 && email.indexOf("@") > 1) {
			if (password.length > 0) {
				if (password == passwordConfirm) {
					auth.createUserWithEmailAndPassword(email, password)
						.then(function () {
							showAlert("Usuari creat correctament", "alert-success");

							document.getElementById("loginForm").style.display = "block";
							document.getElementById("signupForm").style.display = "none";
						})
						.catch(function (error) {
							showAlert("Error al intentar crear l'usuari", "alert-danger");
						});
				} else {
					showAlert("Les contrasenyes no coincideixen", "alert-danger");
				}
			} else {
				showAlert("La contrasenya és obligatòria", "alert-danger");
			}
		} else {
			showAlert("Email incorrecte", "alert-danger");
		}
	});

	document.getElementById("guardar").addEventListener("click", function() {
		let id = document.getElementById("elementId").value;
		let categoria = document.getElementById("categoria").value;
		let circuitos = document.getElementById("circuitos").value;
		let equipos = document.getElementById("equipos").value;
		let data_inici = document.getElementById("data_inici").value;
		let data_fi = document.getElementById("data_fi").value;
		let logoFile = document.getElementById("logo").files[0]; // get the selected file
		
		let doc = {
		  categoria: categoria,
		  circuitos: circuitos,
		  equipos: equipos,
		  data_inici: data_inici,
		  data_fi: data_fi,
		  logo: {
			name: logoFile.name,
			type: logoFile.type,
			size: logoFile.size,
			url: ''
		  }
		};
		
		add(id, doc);
		
		uploadFile(logoFile); // pass the logoFile as a parameter

		updateItem(id, doc, imatgeModificada); // pass the imatgeModificada as a parameter

		document.getElementById("elementId").value = "";
		document.getElementById("categoria").value = "";
		document.getElementById("circuitos").value = "";
		document.getElementById("equipos").value = "";
		document.getElementById("data_inici").value = "";
		document.getElementById("data_fi").value = "";
		document.getElementById("logo").value = "";
	  });

	  function updateItem(id, doc) {
		console.log("Llamando a updateItem con id:", id, "y doc:", doc);
		let data = {
		  categoria: doc.categoria,
		  circuitos: doc.circuitos,
		  equips: doc.equips,
		  data_inici: doc.data_inici,
		  data_fi: doc.data_fi
		};
	  
		if (imatgeModificada) {
		  let logoFile = doc.logo;
		  let logoName = logoFile.name;
		  let logoType = logoFile.type;
		  let logoSize = logoFile.size;
	  
		  let storageRef = firebase.storage().ref();
		  let logoRef = storageRef.child(`/images/Competición${logoName}`);
	  
		  logoRef.put(logoFile)
			.then(() => {
			  logoRef.getDownloadURL()
				.then((url) => {
				  data.logo = url;
				  updateItem(id, data); // Llama a la función updateItem de items.js
				})
				.catch((error) => {
				  console.error("Error al intentar obtener la URL del logo:", error);
				});
			})
			.catch((error) => {
			  console.error("Error al intentar subir el logo:", error);
			});
		} else {
		  updateItem(id, data); // Llama a la función updateItem de items.js
		}
	  }

	  document.getElementById("eliminar").addEventListener("click", function() {
		let id = document.getElementById("elementId").value;
		deleteItem(id);
		// Limpiar valores de los inputs
		document.getElementById("elementId").value = "";
		document.getElementById("categoria").value = "";
		document.getElementById("circuitos").value = "";
		document.getElementById("equipos").value = "";
		document.getElementById("data_inici").value = "";
		document.getElementById("data_fi").value = "";
		document.getElementById("logo").value = "";
	  });

	  
</script>

</html>